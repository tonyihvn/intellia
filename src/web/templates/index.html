{% extends "base.html" %}

{% block title %}OpenMRS Query Assistant{% endblock %}

{% block extra_css %}
<style>
    /* Sidebar Styles */
    .sidebar {
        width: 300px;
        height: calc(100vh - 72px);
        background: #fff;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        position: fixed;
        left: 0;
        top: 72px; /* Account for navbar height */
    }

    .history-item {
        padding: 10px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
    }

    .history-item:hover {
        background: #e9ecef;
    }

    .delete-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #dc3545;
        cursor: pointer;
    }

    /* Main Content Styles */
    .main-content {
        margin-left: 320px;
        padding: 20px;
    }

    .query-container {
        background: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .query-input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: vertical;
        min-height: 100px;
    }

    #result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        background: #f8f9fa;
        min-height: 100px;
    }

    .result-table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
    }

    .result-table th,
    .result-table td {
        padding: 8px;
        border: 1px solid #dee2e6;
    }

    .result-table th {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex">
    <div class="sidebar">
        <h3>Query History</h3>
        <div id="queryHistory">
            <!-- Query history will be dynamically populated here -->
        </div>
    </div>

    <div class="main-content">
        <div class="query-container">
            <header>
                <h2>Natural Language to SQL Query</h2>
            </header>

            <div class="mb-3">
                <label for="questionInput" class="form-label">Enter your question about the OpenMRS database:</label>
                <textarea class="query-input" id="questionInput" rows="4" 
                    placeholder="Example: Show me all patients diagnosed with malaria in the last month"></textarea>
            </div>

            <div class="button-group mb-4">
                <button id="generateBtn" class="btn btn-primary">
                    <i class="fas fa-cog"></i> Go
                </button>
                <button id="executeBtn" class="btn btn-success" disabled>
                    <i class="fas fa-play"></i> Execute Query
                </button>
                <button id="saveBtn" class="btn btn-secondary" disabled>
                    <i class="fas fa-save"></i> Save Query
                </button>
            </div>

            <div id="generatedSQL" class="mb-4" style="display: none;">
                <h3>Generated SQL (editable):</h3>
                <textarea id="sqlEditor" class="form-control" rows="8" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></textarea>
            </div>

            <div id="llmPrompt" class="mb-4" style="display: none;">
                <h3>LLM Prompt (context sent):</h3>
                <pre style="white-space: pre-wrap; font-size: 12px;" id="promptView"></pre>
            </div>

            <div id="result">
                <!-- Query results will be displayed here -->
                <p class="text-muted">Results will appear here after executing the query.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prismjs/1.24.1/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prismjs/1.24.1/components/prism-sql.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.getElementById('generateBtn').addEventListener('click', async () => {
        const question = document.getElementById('questionInput').value.trim();
        if (!question) {
            alert('Please enter a question.');
            return;
        }

        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question })
            });

            const data = await response.json();
            if (data.sql) {
                const editor = document.getElementById('sqlEditor');
                editor.value = data.sql;
                document.getElementById('generatedSQL').style.display = 'block';
                if (data.prompt) {
                    document.getElementById('promptView').textContent = data.prompt;
                    document.getElementById('llmPrompt').style.display = 'block';
                }
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
            } else {
                alert('Failed to generate SQL query.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error generating SQL query.');
        }
    });

    document.getElementById('executeBtn').addEventListener('click', async () => {
        const sql = document.getElementById('sqlEditor').value;
        try {
            const response = await fetch('/api/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sql })
            });

            const data = await response.json();
            displayResults(data);
        } catch (error) {
            console.error('Error:', error);
            alert('Error executing query.');
        }
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
        const question = document.getElementById('questionInput').value;
        const sql = document.getElementById('sqlEditor').value;

        try {
            const response = await fetch('/api/history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question, sql })
            });

            if (response.ok) {
                alert('Query saved successfully!');
                loadQueryHistory();
            } else {
                alert('Failed to save query.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving query.');
        }
    });

    function displayResults(data) {
        const resultDiv = document.getElementById('result');
        if (!data) {
            resultDiv.innerHTML = '<p class="text-muted">No results found.</p>';
            return;
        }

        // Allow output hint in question: text|pdf|xlsx|table|chart
        const question = document.getElementById('questionInput').value.toLowerCase();
        const wantsText = question.includes('text');
        const wantsPdf = question.includes('pdf');
        const wantsExcel = question.includes('excel') || question.includes('xlsx');
        const wantsChart = question.includes('chart') || question.includes('graph');

        if (wantsText && Array.isArray(data) && data.length) {
            const keys = Object.keys(data[0]);
            const lines = data.map(r => keys.map(k => `${k}: ${r[k]}`).join(', '));
            resultDiv.innerHTML = `<pre>${lines.join('\n')}</pre>`;
            return;
        }

        if (wantsExcel) {
            // Offer CSV download as a quick win
            if (!Array.isArray(data) || !data.length) {
                resultDiv.innerHTML = '<p class="text-muted">No data to export.</p>';
                return;
            }
            const headers = Object.keys(data[0]);
            const csv = [headers.join(',')].concat(
                data.map(row => headers.map(h => JSON.stringify(row[h] ?? '')).join(','))
            ).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            resultDiv.innerHTML = `<a href="${url}" download="results.csv" class="btn btn-secondary">Download CSV (Excel)</a>`;
            return;
        }

        if (wantsPdf) {
            // Simple print-to-PDF suggestion; full PDF gen could be added later
            resultDiv.innerHTML = '<p class="text-muted">Use browser Print to save as PDF after viewing the table.</p>';
        }

        if (wantsChart) {
            // Basic bar chart using first numeric column
            if (!Array.isArray(data) || !data.length) {
                resultDiv.innerHTML = '<p class="text-muted">No data to chart.</p>';
                return;
            }
            const keys = Object.keys(data[0]);
            const numericKey = keys.find(k => typeof data[0][k] === 'number') || keys[1] || keys[0];
            const labelKey = keys[0];
            const labels = data.map(r => String(r[labelKey] ?? ''));
            const values = data.map(r => Number(r[numericKey] ?? 0));
            const canvasId = 'chartCanvas';
            resultDiv.innerHTML = `<canvas id="${canvasId}" height="200"></canvas>`;
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: numericKey, data: values, backgroundColor: '#3498db' }] },
            });
            return;
        }

        // Default: table view
        if (!Array.isArray(data) || !data.length) {
            resultDiv.innerHTML = '<p class="text-muted">No results found.</p>';
            return;
        }
        const table = document.createElement('table');
        table.className = 'result-table';
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header] ?? '';
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
        resultDiv.innerHTML = '';
        resultDiv.appendChild(table);
    }

    async function loadQueryHistory() {
        try {
            const response = await fetch('/api/history');
            if (!response.ok) {
                throw new Error('Failed to load history');
            }
            const history = await response.json();
            
            const historyDiv = document.getElementById('queryHistory');
            if (!Array.isArray(history)) {
                historyDiv.innerHTML = '<p class="text-muted">No history available.</p>';
                return;
            }
            
            historyDiv.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadHistoryItem('${item.id}')">
                    <div class="question">${escapeHtml(item.question)}</div>
                    <small class="text-muted">${new Date(item.timestamp).toLocaleString()}</small>
                    <i class="fas fa-trash delete-btn" onclick="deleteHistoryItem(event, '${item.id}')"></i>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading history:', error);
            document.getElementById('queryHistory').innerHTML = 
                '<p class="text-danger">Failed to load history. Please try again.</p>';
        }
    }

    async function loadHistoryItem(id) {
        try {
            const response = await fetch(`/api/history/${id}`);
            if (!response.ok) {
                throw new Error('Failed to load history item');
            }
            const item = await response.json();
            
            document.getElementById('questionInput').value = item.question;
            if (item.sql) {
                document.getElementById('sqlCode').textContent = item.sql;
                document.getElementById('generatedSQL').style.display = 'block';
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
                Prism.highlightElement(document.getElementById('sqlCode'));
            }
        } catch (error) {
            console.error('Error loading history item:', error);
            alert('Error loading history item. Please try again.');
        }
    }

    // Function to escape HTML to prevent XSS
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    async function deleteHistoryItem(event, id) {
        event.stopPropagation();
        if (!confirm('Are you sure you want to delete this query?')) return;

        try {
            const response = await fetch(`/api/history/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete history item');
            }
            
            await loadQueryHistory();
        } catch (error) {
            console.error('Error deleting history item:', error);
            alert('Failed to delete history item. Please try again.');
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        // Load query history when page loads
        loadQueryHistory();
    });

    // Add loading indicators for buttons
    document.getElementById('generateBtn').addEventListener('click', async (event) => {
    const button = event.target;
    const originalText = button.innerHTML;
    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        
        const question = document.getElementById('questionInput').value.trim();
        if (!question) {
            alert('Please enter a question.');
            return;
        }

        const response = await fetch('/api/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                question: question,
                action: 'generate'
            })
        });

        if (!response.ok) {
            throw new Error('Server returned an error');
        }

        const data = await response.json();
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (data.sql) {
            document.getElementById('sqlCode').textContent = data.sql;
            document.getElementById('generatedSQL').style.display = 'block';
            document.getElementById('executeBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            Prism.highlightElement(document.getElementById('sqlCode'));
        } else {
            alert('No SQL query was generated. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error generating SQL query: ' + error.message);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
});
</script>
{% endblock %}