{% extends "base.html" %}

{% block title %}OpenMRS Query Assistant{% endblock %}

{% block extra_css %}
<style>
    /* Sidebar Styles */
    .sidebar {
        width: 300px;
        height: calc(100vh - 72px);
        background: #fff;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        position: fixed;
        left: 0;
        top: 72px;
        /* Account for navbar height */
    }

    .history-item {
        padding: 10px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
    }

    .history-item:hover {
        background: #e9ecef;
    }

    .delete-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #dc3545;
        cursor: pointer;
    }

    /* Main Content Styles */
    .main-content {
        margin-left: 320px;
        padding: 20px;
    }

    .query-container {
        background: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .query-input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: vertical;
        min-height: 100px;
    }

    #result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        background: #f8f9fa;
        min-height: 100px;
    }

    .result-table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
    }

    .result-table th,
    .result-table td {
        padding: 8px;
        border: 1px solid #dee2e6;
    }

    .result-table th {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex">
    <div class="sidebar">
        <h3>Query History</h3>
        <div id="queryHistory">
            <!-- Query history will be dynamically populated here -->
        </div>
    </div>

    <div class="main-content">
        <div class="query-container">
            <header>
                <h2>Natural Language to SQL Query</h2>
            </header>

            <div class="mb-3">
                <label for="questionInput" class="form-label">Enter your question about the OpenMRS database:</label>
                <textarea class="query-input" id="questionInput" rows="4"
                    placeholder="Example: Show me all patients diagnosed with malaria in the last month"></textarea>
            </div>

            <div class="button-group mb-4">
                <button id="generateBtn" class="btn btn-primary">
                    <i class="fas fa-cog"></i> Generate Preview
                </button>
                <button id="executeBtn" class="btn btn-success" disabled>
                    <i class="fas fa-check"></i> Confirm
                </button>
                <button id="saveBtn" class="btn btn-secondary" disabled>
                    <i class="fas fa-save"></i> Save
                </button>
            </div>

            <div id="generatedSQL" class="mb-4" style="display: none;">
                <h3>Generated SQL (editable):</h3>
                <textarea id="sqlEditor" class="form-control" rows="8" spellcheck="false"
                    style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></textarea>
            </div>

            <div id="llmPrompt" class="mb-4" style="display: none;">
                <h3>LLM Prompt (context sent):</h3>
                <pre style="white-space: pre-wrap; font-size: 12px;" id="promptView"></pre>
            </div>

            <div id="result">
                <!-- Query results will be displayed here -->
                <p class="text-muted">Results will appear here after executing the query.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prismjs/1.24.1/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prismjs/1.24.1/components/prism-sql.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let latestPreview = null;

    function renderPreview(preview) {
        const resultDiv = document.getElementById('result');
        document.getElementById('generatedSQL').style.display = 'none';
        document.getElementById('llmPrompt').style.display = 'none';
        resultDiv.innerHTML = '';

        if (!preview) {
            resultDiv.innerHTML = '<p class="text-muted">No preview available.</p>';
            return;
        }

        latestPreview = preview;

        if (preview.type === 'query_preview') {
            if (preview.sql) {
                document.getElementById('sqlEditor').value = preview.sql;
                document.getElementById('generatedSQL').style.display = 'block';
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
            }
            if (preview.results) {
                displayResults(preview.results);
            } else if (preview.error) {
                resultDiv.innerHTML = `<pre class="text-danger">SQL generation/execution error:\n${escapeHtml(preview.error)}</pre>`;
            }
            return;
        }

        if (preview.type === 'action_preview') {
            // Show action details and any SQL/results
            const action = preview.action || {};
            const actionHtml = `<div><strong>Detected action:</strong> ${escapeHtml(action.type || '')}</div>
                <div><strong>Parameters:</strong> <pre>${escapeHtml(JSON.stringify(action.parameters || action || {}, null, 2))}</pre></div>`;
            resultDiv.innerHTML = actionHtml;

            if (preview.sql) {
                document.getElementById('sqlEditor').value = preview.sql;
                document.getElementById('generatedSQL').style.display = 'block';
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
            }

            if (preview.sql_results) {
                displayResults(preview.sql_results);
            } else if (preview.sql_error) {
                resultDiv.innerHTML += `<pre class="text-warning">SQL preview error: ${escapeHtml(preview.sql_error)}</pre>`;
            }
            return;
        }

        resultDiv.innerHTML = '<pre>' + escapeHtml(JSON.stringify(preview, null, 2)) + '</pre>';
    }

    async function confirmExecution() {
        const question = document.getElementById('questionInput').value.trim();
        const sql = document.getElementById('sqlEditor').value;
        const payload = { command: question, sql };
        if (latestPreview && latestPreview.action) payload.action = latestPreview.action;
        if (latestPreview && latestPreview._history_id) payload.history_id = latestPreview._history_id;

        try {
            const resp = await fetch('/api/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await resp.json();
            if (data.error) {
                alert('Execution failed: ' + data.error);
                return;
            }
            if (data.type === 'sql_executed') {
                displayResults(data.results);
            } else if (data.type === 'action_completed') {
                document.getElementById('result').innerHTML = `<div class="alert alert-success">${escapeHtml(data.message || JSON.stringify(data))}</div>`;
            } else if (data.type === 'action_failed') {
                document.getElementById('result').innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error || JSON.stringify(data))}</div>`;
            } else {
                document.getElementById('result').innerHTML = `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
            }
        } catch (e) {
            console.error(e);
            alert('Error executing confirmed action');
        }
    }

    async function generatePreview() {
        const button = document.getElementById('generateBtn');
        const originalText = button.innerHTML;
        try {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            const question = document.getElementById('questionInput').value.trim();
            if (!question) { alert('Please enter a question.'); return; }

            const response = await fetch('/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            });
            if (!response.ok) throw new Error('Server error');
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            // store latest preview including history id
            renderPreview(data);
            latestPreview = data;
        } catch (err) {
            console.error(err);
            alert('Error generating preview: ' + err.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    document.getElementById('generateBtn').addEventListener('click', generatePreview);
    document.getElementById('executeBtn').addEventListener('click', confirmExecution);

    function displayResults(data) {
        const resultDiv = document.getElementById('result');
        if (!data || (Array.isArray(data) && data.length === 0)) {
            resultDiv.innerHTML = '<p class="text-muted">No results found.</p>';
            return;
        }

        // Default: table view
        if (!Array.isArray(data)) {
            resultDiv.innerHTML = '<pre>' + escapeHtml(JSON.stringify(data, null, 2)) + '</pre>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'result-table';
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header] ?? '';
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
        resultDiv.innerHTML = '';
        resultDiv.appendChild(table);
    }

    // Utility functions and initialization
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    async function loadQueryHistory() {
        try {
            const response = await fetch('/api/history');
            if (!response.ok) throw new Error('Failed to load history');
            const history = await response.json();
            const historyDiv = document.getElementById('queryHistory');
            if (!Array.isArray(history)) { historyDiv.innerHTML = '<p class="text-muted">No history available.</p>'; return; }
            historyDiv.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadHistoryItem('${item.id}')">
                    <div class="question">${escapeHtml(item.question)}</div>
                    <small class="text-muted">${new Date(item.timestamp).toLocaleString()}</small>
                    <i class="fas fa-trash delete-btn" onclick="deleteHistoryItem(event, '${item.id}')"></i>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading history:', error);
            document.getElementById('queryHistory').innerHTML = '<p class="text-danger">Failed to load history.</p>';
        }
    }

    async function loadHistoryItem(id) {
        try {
            const response = await fetch(`/api/history/${id}`);
            if (!response.ok) throw new Error('Failed to load history item');
            const item = await response.json();
            document.getElementById('questionInput').value = item.question;
            if (item.sql) {
                document.getElementById('sqlEditor').value = item.sql;
                document.getElementById('generatedSQL').style.display = 'block';
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
            }
        } catch (error) {
            console.error('Error loading history item:', error);
            alert('Error loading history item.');
        }
    }

    async function deleteHistoryItem(event, id) {
        event.stopPropagation();
        if (!confirm('Are you sure?')) return;
        try {
            const response = await fetch(`/api/history/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Failed to delete');
            await loadQueryHistory();
        } catch (error) {
            console.error('Error deleting history item:', error);
            alert('Failed to delete history item.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => { loadQueryHistory(); });
</script>
{% endblock %}